#!/bin/bash
#--------------------------------------------------------------
# This scripts bootstraps a linux node by installing a puppet
# master.
#
# The firewall must be disabled to function correctly.
#   Ubuntu:   "sudo systemctl disable ufw"
#   Centos:   "sudo iptables -F"
#--------------------------------------------------------------
set -x

#--------------------------------------------------------------
# Redirect all stdout and stderr to logfile,
#--------------------------------------------------------------
echo "======================= Executing setup_logging ======================="
cd "" || exit 1
exec > "" 2>&1

echo "Completed the Bootstrap"

on of Puppet
#   - POS:        Operating System Version
#   - PFILE:      PE Installation File
#   - PURL:       URI of the download file
#   - Email:      Puppet Email Name
#   - GITURL:     Code Manager Control Repo
#
# Environment Variables:
#   - GIT_PRI:  Git SSH Private Key
#   - GIT_PUB:  Git SSH Public Key
#--------------------------------------------------------------
PATH=/usr/local/opt/ruby/bin:/usr/local/sbin:/Users/chris.roberson/.rbenv/shims:/Users/chris.roberson/.rbenv/shims:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/opt/puppetlabs/bin:/usr/local/munki:/opt/puppetlabs/pdk/bin:/Applications/Wireshark.app/Contents/MacOS:/Users/chris.roberson/.bin:/opt/puppetlabs/bin:/opt/puppetlabs/pdk/bin:/opt/puppetlabs/bolt/bin:/opt/puppetlabs/bin
HOME=/root
WORKDIR="/tmp"
LOGFILE="/bootstrap10673.log"
PVER="2019.1.0"
POS="ubuntu-18.04"
PFILE="puppet-enterprise---amd64.tar.gz"
PURL="https://pm.puppetlabs.com/puppet-enterprise//"
EMAIL="chris.roberson@puppet.com"
GITURL="https://github.com/cdrobey/puppet-repo"
GIT_PUB=ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQCWoB5JzTy/fJWSlCOjHBgLvVEoDajNrXzb+/MIMLpCw7vjKd6CQkjKe1pTbQFs3J/pVbMTxFh52xkpQp0hUDhto6tNqpl9AFmv1myN9Gh3sHSgKvpmmAMdrR4Ejat8eUra19qGcU7zuwOr/LnQTizLkUdQ2HiTFLWDgT5rkQ5QTRgqeBuYCoajZ/SjM1c+9SK6L+Qyj2fW4UhhuxR6iVJZRGaNAEYMLwfKaeBgUZ/lTLvzZpqzJkh/1xCQmZQnmvFupr1aWbBo5WeX456jfK4nR4wOpoOKtPWIhv4zFVXHfsqGejFwbROZ4N7SeC8WAx6gjEU9grmstELVItDA45irKDXr6caP/lF3PQU539LI1G1R3xVL7hXlc/VtdwtGiLzFTPjwOAdc1q5INUGGz+fvlQKkhpZsbT/27WnKQHN9WQtTcJS3wO1yJ1g5JxZKet5VXuTHgTb34rj/VYgfRTbvXHzybZhllO6rCAUnNWFurlGItUmSRAgmNIOO3tN98O8iKo8/l0ETp6WQH9WwU7tctH44+jdJCAoiJtzab2YGtV8Ef4TmPkRcXGuAfYx63IhUiSvDaUSelKlFOdZRjFwggP9iWmLzvlTgjqQjowcanP5MGADg29nBVI3loxxmLA4gJNoz33NjwC7xgAY0rGN4+hK3Uuaxm8aK4OYv5dv92w== cdroberson@gmail.com

GIT_PRI=-----BEGIN RSA PRIVATE KEY-----
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
-----END RSA PRIVATE KEY-----


#--------------------------------------------------------------
# Redirect all stdout and stderr to logfile,
#--------------------------------------------------------------
echo "======================= Executing setup_logging ======================="
cd "" || exit 1
exec > "" 2>&1

#--------------------------------------------------------------
# Initiate Puppet Run.
#--------------------------------------------------------------
function run_puppet {
  echo "======================= Executing run_puppet ======================="

  cd / || exit 1
  puppet agent -t
}

#--------------------------------------------------------------
# Peform pre-master installation tasks.
#--------------------------------------------------------------
function pre_install_pe {
  echo "======================= Executing pre_install_pa ======================="

  wget 
  tar -xzf  -C /tmp/
  mkdir -p /etc/puppetlabs/puppet/
  echo "*" > /etc/puppetlabs/puppet/autosign.conf
  cat > /etc/puppetlabs/puppet/csr_attributes.yaml << YAML
extension_requests:
    pp_role:  puppetmaster
YAML
}

#--------------------------------------------------------------
# Peform post-master installation tasks.
#--------------------------------------------------------------
function post_install_pe {
  echo "======================= Executing post_install_pe ======================="

  mkdir -p /etc/puppetlabs/puppetserver/ssh

  cat > /etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa << FILE

FILE
  chmod 400 /etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa
  chown pe-puppet:pe-puppet /etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa


  cat > /etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa.pub << FILE

FILE
  chmod 400 /etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa.pub
  chown pe-puppet:pe-puppet /etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa.pub


  puppet module install pltraining-rbac
  cat > /tmp/user.pp << FILE
rbac_user { 'deploy':
    ensure       => 'present',
    name         => 'deploy',
    display_name => 'deployment user account',
    email        => '',
    password     => 'puppetlabs',
    roles        => [ 'Code Deployers' ],
}
FILE
  puppet apply /tmp/user.pp
  rm /tmp/user.pp
  puppet-access -t /Users/chris.roberson/.puppetlabs/token login --lifetime=1y << TEXT
deploy
puppetlabs
TEXT

  puppet-code -t /Users/chris.roberson/.puppetlabs/token deploy production -w
  puppet agent -t
}
#--------------------------------------------------------------
# Peform master installation tasks.
#--------------------------------------------------------------
function install_pe {
  echo "======================= Executing install_pe ======================="

  cat > /tmp/pe.conf << FILE
"console_admin_password": "puppetlabs"
"puppet_enterprise::puppet_master_host": "%{::trusted.certname}"
"puppet_enterprise::profile::master::code_manager_auto_configure": true
"puppet_enterprise::profile::master::r10k_remote": ""
"puppet_enterprise::profile::master::r10k_private_key": "/etc/puppetlabs/puppetserver/ssh/id-control_repo.rsa"
FILE
  /tmp/puppet-enterprise---amd64/puppet-enterprise-installer -c /tmp/pe.conf
  chown pe-puppet:pe-puppet /etc/puppetlabs/puppetserver/ssh/id-*
}

setup_host_name
pre_install_pe
install_pe
post_install_pe
run_puppet

echo "Completed the Bootstrap of Puppet Enterprise!"

